<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BRC Platform - Module Builder Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-section { 
            background: #f8f9fa; 
            padding: 20px; 
            margin: 20px 0; 
            border-radius: 8px; 
            border-left: 4px solid #007bff;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .info { color: #17a2b8; }
        .test-result { 
            background: #ffffff; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border: 1px solid #ddd;
        }
        .module-form {
            background: #ffffff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .ajax-log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        .food-safety-card {
            border: 2px solid #28a745;
            border-radius: 10px;
            transition: transform 0.2s;
        }
        .food-safety-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">ğŸ› ï¸ BRC Platform - Module Builder Test</h1>
                <div class="alert alert-success">
                    <strong>âœ… Sistem Durumu:</strong> Session aktif, Database baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±, AJAX endpoint'ler Ã§alÄ±ÅŸÄ±yor!
                </div>
            </div>
        </div>
        
        <!-- HÄ±zlÄ± Testler -->
        <div class="test-section">
            <h3>âš¡ HÄ±zlÄ± Testler</h3>
            <div class="test-result">
                <button class="btn btn-primary me-2" onclick="testModuleBuilder()">Module Builder Test</button>
                <button class="btn btn-info me-2" onclick="testDataActions()">Data Actions Test</button>
                <button class="btn btn-success me-2" onclick="getAllModules()">ModÃ¼lleri YÃ¼kle</button>
                <button class="btn btn-warning me-2" onclick="testCreateModule()">HÄ±zlÄ± ModÃ¼l OluÅŸtur</button>
                <button class="btn btn-secondary" onclick="clearLog()">Log Temizle</button>
            </div>
            <div id="quick-test-results"></div>
        </div>

        <!-- GÄ±da GÃ¼venliÄŸi HÄ±zlÄ± ModÃ¼lleri -->
        <div class="test-section">
            <h3>ğŸ¥˜ GÄ±da GÃ¼venliÄŸi ModÃ¼lleri - HÄ±zlÄ± OluÅŸturucu</h3>
            <div class="row">
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card food-safety-card">
                        <div class="card-body position-relative">
                            <span class="badge bg-success status-badge">BRC Standart</span>
                            <h5 class="card-title">ğŸ” Kalite Kontrol PlanÄ±</h5>
                            <p class="card-text">FÃ¼migasyon, yÄ±kama, seÃ§im sÃ¼reÃ§lerinizi dijital takip</p>
                            <ul class="list-unstyled small">
                                <li>âœ“ SÃ¼reÃ§ kontrol noktalarÄ±</li>
                                <li>âœ“ Sorumlu kiÅŸi atamalarÄ±</li>
                                <li>âœ“ DÃ¼zeltici faaliyetler</li>
                            </ul>
                            <button class="btn btn-primary w-100" onclick="createQualityModule()">OluÅŸtur</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card food-safety-card">
                        <div class="card-body position-relative">
                            <span class="badge bg-info status-badge">Ä°zlenebilirlik</span>
                            <h5 class="card-title">ğŸ“‹ Parti Takip Sistemi</h5>
                            <p class="card-text">Ä°-017 tarzÄ± parti numaralarÄ±yla sÃ¼reÃ§ geÃ§miÅŸi</p>
                            <ul class="list-unstyled small">
                                <li>âœ“ Hammadde takibi</li>
                                <li>âœ“ Ãœretim geÃ§miÅŸi</li>
                                <li>âœ“ Sertifika yÃ¶netimi</li>
                            </ul>
                            <button class="btn btn-primary w-100" onclick="createTraceabilityModule()">OluÅŸtur</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card food-safety-card">
                        <div class="card-body position-relative">
                            <span class="badge bg-warning status-badge">Laboratuvar</span>
                            <h5 class="card-title">ğŸ§ª Analiz Takip</h5>
                            <p class="card-text">Aflatoksin, nem, mikrobiyolojik test sonuÃ§larÄ±</p>
                            <ul class="list-unstyled small">
                                <li>âœ“ Test planlamasÄ±</li>
                                <li>âœ“ SonuÃ§ takibi</li>
                                <li>âœ“ Uygunluk kontrolÃ¼</li>
                            </ul>
                            <button class="btn btn-primary w-100" onclick="createAnalysisModule()">OluÅŸtur</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card food-safety-card">
                        <div class="card-body position-relative">
                            <span class="badge bg-secondary status-badge">KÃ¼ltÃ¼r</span>
                            <h5 class="card-title">ğŸ‘¥ Ã‡alÄ±ÅŸan DeÄŸerlendirme</h5>
                            <p class="card-text">GÄ±da gÃ¼venliÄŸi kÃ¼ltÃ¼rÃ¼ anket sistemi</p>
                            <ul class="list-unstyled small">
                                <li>âœ“ Anket yÃ¶netimi</li>
                                <li>âœ“ SonuÃ§ analizi</li>
                                <li>âœ“ EÄŸitim planlamasÄ±</li>
                            </ul>
                            <button class="btn btn-primary w-100" onclick="createCultureModule()">OluÅŸtur</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card food-safety-card">
                        <div class="card-body position-relative">
                            <span class="badge bg-dark status-badge">Spesifikasyon</span>
                            <h5 class="card-title">ğŸ“„ ÃœrÃ¼n StandartlarÄ±</h5>
                            <p class="card-text">Kuru incir TS 541 standart yÃ¶netimi</p>
                            <ul class="list-unstyled small">
                                <li>âœ“ Fiziksel Ã¶zellikler</li>
                                <li>âœ“ Kimyasal analiz</li>
                                <li>âœ“ Mikrobiyolojik testler</li>
                            </ul>
                            <button class="btn btn-primary w-100" onclick="createSpecificationModule()">OluÅŸtur</button>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card food-safety-card">
                        <div class="card-body position-relative">
                            <span class="badge bg-danger status-badge">HACCP</span>
                            <h5 class="card-title">âš ï¸ Risk DeÄŸerlendirme</h5>
                            <p class="card-text">BRC uyumlu tehlike analizi sistemi</p>
                            <ul class="list-unstyled small">
                                <li>âœ“ Tehlike tanÄ±mlama</li>
                                <li>âœ“ Risk matrisi</li>
                                <li>âœ“ Kritik kontrol noktalarÄ±</li>
                            </ul>
                            <button class="btn btn-primary w-100" onclick="createHACCPModule()">OluÅŸtur</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Manuel ModÃ¼l OluÅŸturma -->
        <div class="test-section">
            <h3>â• Manuel ModÃ¼l OluÅŸtur</h3>
            <div class="module-form">
                <form id="module-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="module-name" class="form-label">ModÃ¼l AdÄ±</label>
                                <input type="text" class="form-control" id="module-name" placeholder="Ã–rn: Ã–zel Kalite Kontrol Sistemi">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="module-category" class="form-label">Kategori</label>
                                <select class="form-control" id="module-category">
                                    <option value="quality_control">Kalite Kontrol</option>
                                    <option value="traceability">Ä°zlenebilirlik</option>
                                    <option value="specifications">Spesifikasyon</option>
                                    <option value="laboratory">Laboratuvar</option>
                                    <option value="culture">KÃ¼ltÃ¼r</option>
                                    <option value="haccp">HACCP</option>
                                    <option value="general">Genel</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="module-description" class="form-label">AÃ§Ä±klama</label>
                        <textarea class="form-control" id="module-description" rows="3" placeholder="ModÃ¼lÃ¼n ne iÅŸe yaradÄ±ÄŸÄ±nÄ± aÃ§Ä±klayÄ±n..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-success me-2">ModÃ¼l OluÅŸtur</button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Formu Temizle</button>
                </form>
            </div>
        </div>

        <!-- Mevcut ModÃ¼ller -->
        <div class="test-section">
            <h3>ğŸ“‹ Mevcut ModÃ¼ller</h3>
            <div id="modules-list">
                <div class="text-center">
                    <button class="btn btn-info" onclick="loadModules()">ModÃ¼lleri YÃ¼kle</button>
                </div>
                <div id="modules-container"></div>
            </div>
        </div>

        <!-- AJAX Log -->
        <div class="test-section">
            <h3>ğŸ“ AJAX Test Log</h3>
            <div class="ajax-log" id="ajax-log">
                ğŸš€ BRC Platform Module Builder Test Console baÅŸlatÄ±ldÄ±...<br>
                âœ… Session: Admin ID 1 aktif<br>
                âœ… Database: BaÄŸlantÄ± baÅŸarÄ±lÄ±<br>
                ğŸ“¡ AJAX endpoint'ler hazÄ±r...<br>
            </div>
        </div>
    </div>

    <script>
        // Session bilgileri (gerÃ§ek session'dan alÄ±nacak)
        let sessionInfo = {
            adminId: 1,
            userId: 1,
            companyId: 1,
            csrfToken: 'dynamic_token'
        };
        
        // Log fonksiyonu
        function log(message, type = 'info') {
            const logElement = document.getElementById('ajax-log');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                'success': '#00ff00',
                'error': '#ff0000', 
                'info': '#00ffff',
                'warning': '#ffff00'
            };
            const color = colors[type] || '#ffffff';
            
            logElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span><br>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        function clearLog() {
            document.getElementById('ajax-log').innerHTML = 'ğŸ§¹ Log temizlendi...<br>';
        }

        // AJAX helper function
        async function makeAjaxRequest(url, data) {
            log(`ğŸ“¡ Request: ${url}`, 'info');
            log(`ğŸ“¤ Data: ${JSON.stringify(data)}`, 'info');
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                const responseData = await response.json();
                
                if (response.ok) {
                    log(`âœ… Success (${response.status}): ${JSON.stringify(responseData)}`, 'success');
                } else {
                    log(`âŒ Error (${response.status}): ${JSON.stringify(responseData)}`, 'error');
                }
                
                return { success: response.ok, data: responseData, status: response.status };
                
            } catch (error) {
                log(`ğŸ’¥ Exception: ${error.message}`, 'error');
                return { success: false, error: error.message };
            }
        }

        // Test fonksiyonlarÄ±
        async function testModuleBuilder() {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'test_connection'
            });
            
            showTestResult('Module Builder Test', result);
        }

        async function testDataActions() {
            const result = await makeAjaxRequest('customer/ajax/data-actions.php', {
                action: 'test_save',
                test_field: 'test_value'
            });
            
            showTestResult('Data Actions Test', result);
        }

        async function getAllModules() {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'get_modules'
            });
            
            showTestResult('Get All Modules', result);
            
            if (result.success && result.data.modules) {
                displayModules(result.data.modules);
            }
        }

        async function testCreateModule() {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'create_module',
                name: 'Test ModÃ¼lÃ¼ ' + Date.now(),
                description: 'Otomatik test modÃ¼lÃ¼',
                category: 'general'
            });
            
            showTestResult('HÄ±zlÄ± ModÃ¼l OluÅŸturma', result);
            
            if (result.success) {
                setTimeout(loadModules, 1000);
            }
        }

        // GÄ±da gÃ¼venliÄŸi modÃ¼lleri
        async function createQualityModule() {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'create_module',
                name: 'BRC Kalite Kontrol PlanÄ± v2.0',
                description: 'FÃ¼migasyon, yÄ±kama, seÃ§im, aflatoksin kontrolÃ¼ ve son kontrol sÃ¼reÃ§lerini kapsayan kapsamlÄ± kalite kontrol sistemi',
                category: 'quality_control'
            });
            
            if (result.success) {
                log('ğŸ¥˜ Kalite Kontrol PlanÄ± modÃ¼lÃ¼ baÅŸarÄ±yla oluÅŸturuldu!', 'success');
                loadModules();
            }
        }

        async function createTraceabilityModule() {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'create_module',
                name: 'Ä°zlenebilirlik Sistemi v2.0',
                description: 'Ä°-017 tarzÄ± parti numaralarÄ±, hammadde giriÅŸi, fÃ¼migasyon, Ã¼retim ve sevkiyat sÃ¼reÃ§lerinin tam takip sistemi',
                category: 'traceability'
            });
            
            if (result.success) {
                log('ğŸ“‹ Ä°zlenebilirlik Sistemi modÃ¼lÃ¼ baÅŸarÄ±yla oluÅŸturuldu!', 'success');
                loadModules();
            }
        }

        async function createAnalysisModule() {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'create_module',
                name: 'Analiz Takip Sistemi v2.0',
                description: 'Aflatoksin, nem, mikrobiyolojik, pestisit ve aÄŸÄ±r metal analizlerinin planlanmasÄ± ve sonuÃ§larÄ±nÄ±n takip sistemi',
                category: 'laboratory'
            });
            
            if (result.success) {
                log('ğŸ§ª Analiz Takip Sistemi modÃ¼lÃ¼ baÅŸarÄ±yla oluÅŸturuldu!', 'success');
                loadModules();
            }
        }

        async function createCultureModule() {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'create_module',
                name: 'GÄ±da GÃ¼venliÄŸi KÃ¼ltÃ¼rÃ¼ Ã–lÃ§Ã¼mÃ¼ v2.0',
                description: '23 soruluk Ã§alÄ±ÅŸan deÄŸerlendirme anketi, demografik analiz ve kÃ¼ltÃ¼r iyileÅŸtirme Ã¶nerileri sistemi',
                category: 'culture'
            });
            
            if (result.success) {
                log('ğŸ‘¥ GÄ±da GÃ¼venliÄŸi KÃ¼ltÃ¼rÃ¼ modÃ¼lÃ¼ baÅŸarÄ±yla oluÅŸturuldu!', 'success');
                loadModules();
            }
        }

        async function createSpecificationModule() {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'create_module',
                name: 'ÃœrÃ¼n Spesifikasyon YÃ¶netimi v2.0',
                description: 'TS 541 Kuru Ä°ncir standardÄ±, fiziksel-kimyasal-mikrobiyolojik Ã¶zellikler ve beslenme deÄŸerleri yÃ¶netimi',
                category: 'specifications'
            });
            
            if (result.success) {
                log('ğŸ“„ ÃœrÃ¼n Spesifikasyon modÃ¼lÃ¼ baÅŸarÄ±yla oluÅŸturuldu!', 'success');
                loadModules();
            }
        }

        async function createHACCPModule() {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'create_module',
                name: 'BRC HACCP Risk DeÄŸerlendirme v2.0',
                description: 'Tehlike analizi, risk matrisi, kritik kontrol noktalarÄ± ve izleme prosedÃ¼rleri sistemi',
                category: 'haccp'
            });
            
            if (result.success) {
                log('âš ï¸ HACCP Risk DeÄŸerlendirme modÃ¼lÃ¼ baÅŸarÄ±yla oluÅŸturuldu!', 'success');
                loadModules();
            }
        }

        // Test sonuÃ§larÄ±nÄ± gÃ¶ster
        function showTestResult(testName, result) {
            const resultsDiv = document.getElementById('quick-test-results');
            const resultClass = result.success ? 'alert-success' : 'alert-danger';
            const icon = result.success ? 'âœ…' : 'âŒ';
            
            resultsDiv.innerHTML = `
                <div class="alert ${resultClass} mt-3">
                    <h6>${icon} ${testName}</h6>
                    <pre style="font-size: 12px; margin: 0;">${JSON.stringify(result, null, 2)}</pre>
                </div>
            `;
        }

        // ModÃ¼l formu submit
        document.getElementById('module-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('module-name').value;
            const description = document.getElementById('module-description').value;
            const category = document.getElementById('module-category').value;
            
            if (!name.trim()) {
                alert('ModÃ¼l adÄ± gerekli!');
                return;
            }

            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'create_module',
                name: name,
                description: description,
                category: category
            });

            if (result.success) {
                log(`ğŸ‰ "${name}" modÃ¼lÃ¼ baÅŸarÄ±yla oluÅŸturuldu!`, 'success');
                resetForm();
                loadModules();
            } else {
                log(`ğŸ’¥ ModÃ¼l oluÅŸturulamadÄ±: ${result.data?.error || result.error}`, 'error');
            }
        });

        // ModÃ¼lleri yÃ¼kle ve gÃ¶ster
        async function loadModules() {
            log('ğŸ“‹ ModÃ¼ller yÃ¼kleniyor...', 'info');
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'get_modules'
            });
            
            if (result.success && result.data.modules) {
                displayModules(result.data.modules);
                log(`âœ… ${result.data.modules.length} modÃ¼l yÃ¼klendi`, 'success');
            }
        }

        function displayModules(modules) {
            const container = document.getElementById('modules-container');
            
            if (modules.length === 0) {
                container.innerHTML = '<p class="text-muted mt-3">HenÃ¼z modÃ¼l bulunmuyor.</p>';
                return;
            }
            
            let html = '<div class="row mt-3">';
            
            modules.forEach(module => {
                const categoryColors = {
                    'quality_control': 'success',
                    'traceability': 'info', 
                    'laboratory': 'warning',
                    'culture': 'secondary',
                    'specifications': 'dark',
                    'haccp': 'danger',
                    'general': 'primary'
                };
                
                const badgeColor = categoryColors[module.category] || 'primary';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">${module.name}</h6>
                                <p class="card-text small">${module.description || 'AÃ§Ä±klama yok'}</p>
                                <div class="mb-2">
                                    <span class="badge bg-${badgeColor}">${module.category}</span>
                                    <span class="badge bg-light text-dark">${module.component_count || 0} component</span>
                                </div>
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editModule(${module.id})">DÃ¼zenle</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteModule(${module.id})">Sil</button>
                                </div>
                                <small class="text-muted d-block mt-2">
                                    OluÅŸturulma: ${new Date(module.created_at).toLocaleDateString('tr-TR')}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // ModÃ¼l dÃ¼zenleme ve silme
        async function editModule(moduleId) {
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'get_module_details',
                module_id: moduleId
            });
            
            if (result.success) {
                const module = result.data.module;
                document.getElementById('module-name').value = module.name;
                document.getElementById('module-description').value = module.description || '';
                document.getElementById('module-category').value = module.category;
                
                document.getElementById('module-form').scrollIntoView({ behavior: 'smooth' });
                log(`ğŸ“ "${module.name}" modÃ¼lÃ¼ dÃ¼zenleme iÃ§in yÃ¼klendi`, 'info');
            }
        }

        async function deleteModule(moduleId) {
            if (!confirm('Bu modÃ¼lÃ¼ silmek istediÄŸinizden emin misiniz?')) {
                return;
            }
            
            const result = await makeAjaxRequest('platform/ajax/module-builder.php', {
                action: 'delete_module',
                module_id: moduleId
            });
            
            if (result.success) {
                log('ğŸ—‘ï¸ ModÃ¼l baÅŸarÄ±yla silindi!', 'success');
                loadModules();
            } else {
                log(`ğŸ’¥ ModÃ¼l silinemedi: ${result.data?.error || result.error}`, 'error');
            }
        }

        function resetForm() {
            document.getElementById('module-form').reset();
        }

        // Sayfa yÃ¼klendiÄŸinde
        window.addEventListener('load', function() {
            log('ğŸš€ BRC Platform Module Builder Test sayfasÄ± yÃ¼klendi', 'success');
            log('ğŸ¥˜ GÄ±da gÃ¼venliÄŸi modÃ¼lleri hazÄ±r!', 'info');
            
            // 2 saniye sonra otomatik test
            setTimeout(() => {
                log('ğŸ”„ Otomatik testler baÅŸlÄ±yor...', 'info');
                testModuleBuilder();
                
                // 1 saniye sonra modÃ¼lleri yÃ¼kle
                setTimeout(loadModules, 1000);
            }, 2000);
        });
    </script>
</body>
</html>